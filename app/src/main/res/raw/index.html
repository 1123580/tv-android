<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta content="width=device-width, initial-scale=1" name="viewport">
        <title>我的电视</title>
        <!-- 重置css -->
        <link href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css" rel="stylesheet">

        <!-- 核心 -->
        <script src="https://cdn.jsdelivr.net/npm/vue@3.4.23/dist/vue.global.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@unocss/runtime"></script>

        <!-- 日期格式化 -->
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>

        <!-- vant -->
        <link href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css" rel="stylesheet" />
        <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>

        <!-- 工具 -->
        <script src="https://cdn.jsdelivr.net/npm/humanize-duration@3.32.0/humanize-duration.min.js"></script>

        <style>
            .van-theme-dark body {
                color: #f5f5f5;
                background-color: black;
            }
        </style>
    </head>

    <body>
        <div class="min-h-100vh py-46px" id="app">
            <van-config-provider :theme="isDark ? 'dark' : undefined">
                <template v-if="settings">
                    <div class="p-20px pt-0">
                        <div class="ml-16px text-32px">{{ settings.appTitle }}</div>
                        <div class="ml-16px text-gray text-14px">{{ settings.appRepo }}</div>
                    </div>

                    <van-cell-group inset title="通知">
                        <van-cell title="修改之前请先关闭应用的设置界面，否则会有冲突"></van-cell>
                        <van-cell title="以下设置修改后，需要重启应用生效"></van-cell>
                    </van-cell-group>

                    <van-cell-group inset title="直播源">
                        <van-cell title="自定义直播源">
                            <template #label>
                                <van-space class="w-full" direction="vertical" size="small">
                                    <span>支持m3u链接与tvbox链接，推送后请清除缓存</span>
                                    <van-field class="!p-0" placeholder="置为空时，将恢复默认"
                                            v-model="settings.iptvSourceUrl"></van-field>
                                </van-space>
                            </template>

                            <template #extra>
                                <van-button @click="settings.iptvSourceCachedAt = 0; confirmSettings()" size="small"
                                        type="primary">推送链接
                                </van-button>
                            </template>
                        </van-cell>
                    </van-cell-group>

                    <van-cell-group inset title="节目单">
                        <van-cell title="自定义节目单">
                            <template #label>
                                <van-space class="w-full" direction="vertical" size="small">
                                    <span>支持xml、xml.gz格式，推送后请清除缓存</span>
                                    <van-field class="!p-0" placeholder="置为空时，将恢复默认" v-model="settings.epgXmlUrl"></van-field>
                                </van-space>
                            </template>

                            <template #extra>
                                <van-button
                                        @click="settings.epgXmlCachedAt = 0; settings.epgCachedHash = 0; confirmSettings()"
                                        size="small" type="primary">推送链接
                                </van-button>
                            </template>
                        </van-cell>
                    </van-cell-group>

                    <van-cell-group inset title="调试">
                        <van-cell title="上传apk">
                            <template #extra>
                                <van-uploader :after-read="uploaderAfterRead" accept=".apk" />
                            </template>
                        </van-cell>
                    </van-cell-group>

                    <!-- <van-tabbar>
                            <van-tabbar-item name="home" icon="tv-o">直播源</van-tabbar-item>
                            <van-tabbar-item name="search" icon="list-switch">节目单</van-tabbar-item>
                            <van-tabbar-item name="friends" icon="brush-o">界面</van-tabbar-item>
                            <van-tabbar-item name="setting" icon="setting-o">应用</van-tabbar-item>
                            <van-tabbar-item name="setting" icon="bulb-o">调试</van-tabbar-item>
                        </van-tabbar> -->
                </template>

                <van-empty image="network" v-else />
            </van-config-provider>
        </div>

        <script>
            const { createApp, ref, onMounted, watch, nextTick } = Vue

            const baseUrl = ""

            async function requestApi(url, config) {
                const resp = await fetch(`${baseUrl}${url}`, config)
                if (resp.status !== 200) {
                    throw new Error(`请求失败：${resp.status}`)
                }

                return resp
            }

            dayjs.locale('zh-cn')
            dayjs.extend(dayjs_plugin_relativeTime)

            createApp({
                setup() {
                    const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches

                    const tabActive = ref(0)

                    const settings = ref()
                    async function confirmSettings() {
                        try {
                            vant.showLoadingToast({ message: '加载中...', forbidClick: true, duration: 0 })
                            await requestApi('/api/settings', {
                                method: "POST",
                                body: JSON.stringify(settings.value),
                                headers: { 'Content-Type': 'application/json' }
                            })
                            await refreshSettings()
                            vant.closeToast()
                        } catch (e) {
                            vant.showFailToast('无法修改设置')
                            console.error(e)
                            refreshSettings()
                        }
                    }
                    async function refreshSettings() {
                        try {
                            vant.showLoadingToast({ message: '加载中...', forbidClick: true, duration: 0 })
                            settings.value = await (await requestApi('/api/settings')).json()
                            vant.closeToast()
                        } catch (e) {
                            vant.showFailToast('无法获取设置')
                            console.error(e)
                        }
                    }


                    onMounted(async () => {
                        await refreshSettings()
                    })

                    function foramtDuration(ms) {
                        return humanizeDuration(ms, { language: 'zh_CN', round: true, largest: 2 })
                    }

                    async function uploaderAfterRead(file) {
                        try {
                            vant.showLoadingToast({ message: '加载中...', forbidClick: true, duration: 0 })
                            const formData = new FormData()
                            formData.append('filename', file.file)
                            await requestApi('/api/upload/apk', { method: "POST", body: formData })
                            vant.closeToast()
                        } catch (e) {
                            vant.showFailToast('上传apk失败')
                            console.error(e)
                        }
                    }

                    return {
                        dayjs,
                        foramtDuration,
                        isDark,
                        tabActive,
                        settings,
                        confirmSettings,
                        uploaderAfterRead,
                    }
                }
            })
                .use(vant)
                .mount('#app')
        </script>
    </body>

</html>
